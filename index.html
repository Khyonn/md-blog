<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json" />
    <title>Khyonn's blog</title>
    <style>
      *,
      ::before,
      ::after {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: sans-serif;
      }
      header {
        background-color: blueviolet;
        color: white;
        box-shadow: 0 5px 5px 0 rgb(0 0 0 / 0.2);
      }
      nav {
        height: 4rem;
        padding: .5rem;
        display: flex;
        align-items: center;
      }
      nav a {
        color: currentColor;
        text-decoration: none;
      }
      nav a:first-child + a {
        margin-left: 2rem;
      }
      nav a + a {
        margin-left: 1rem;
      }
      @media screen and (min-width: 650px) {
        nav,
        main {
          margin-inline: 2rem;
        }
      }
      @media screen and (min-width: 950px) {
        nav,
        main {
          margin-inline: auto;
          width: min(80%, 60rem);
        }
      }
      #__content__ {
        padding-inline: .2rem;
      }
    </style>
  </head>
  <body>
    <header>
      <nav>
        <a href=".">Accueil</a>
        <a href="?page=code">Code</a>
        <a href="?page=ecologie">Ecologie</a>
      </nav>
    </header>
    <main>
      <noscript>You should enable Javascript ... :(</noscript>
      <div id="__content__"></div>
    </main>
    <script>      
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("./sw.js");
      }
      // load content if not present
      if (!document.getElementById("__content__").innerText.trim().length) {
        const markedScript = document.createElement("script");
        markedScript.src = "./assets/scripts/marked.min.js";
        markedScript.onload = () => {
          fetch(`./pages/${new URLSearchParams(location.search).get("page") ?? "home"}.md`)
            .catch(() => caches.match("./pages/offline.md"))
            .then((response) => (response.ok ? response : caches.match("./pages/notfound.md")))
            .then((response) => response && response.text())
            .then((mdText) => {
              const mdHtml = marked.parse(mdText);
              const content = document.getElementById("__content__");
              content.innerHTML = mdHtml;
              document.title = mdHtml.match(/<h1(?:.*)>(.+)<\/h1>/)?.at(1) ?? document.title;
              Array.from(content.querySelectorAll("script")).forEach((notWorkingScript) => {
                const workingScript = document.createElement("script");
                workingScript.text = notWorkingScript.innerHTML;
                for (let attribute of notWorkingScript.attributes) {
                  workingScript.setAttribute(attribute.name, attribute.value);
                }
                notWorkingScript.replaceWith(workingScript);
              });
            });
        };
        document.body.append(markedScript);
      }
    </script>
  </body>
</html>
